# .github/workflows/deploy-pages.yml
name: Build and deploy to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Build production files
        run: npm run build

      - name: Prepare Pages artifact (detect build folder, add .nojekyll + 404)
        id: prepare
        run: |
          set -e
          if [ -d "dist" ]; then
            BUILD_DIR="dist"
          elif [ -d "build" ]; then
            BUILD_DIR="build"
          else
            echo "No build output found (dist/ or build/). Listing repo root for debugging:" >&2
            ls -la
            exit 1
          fi

          echo "Detected build directory: $BUILD_DIR"

          # Create .nojekyll and a relative SPA 404 fallback (use ./ so it works for project pages)
          touch "$BUILD_DIR/.nojekyll"
          printf '%s\n' '<!doctype html>' '<meta charset="utf-8"/>' '<title>Redirectingâ€¦</title>' '<meta http-equiv="refresh" content="0; URL=./" />' "<script>location.replace('./')</script>" > "$BUILD_DIR/404.html"

          # Export detected build dir to subsequent steps
          echo "build_dir=$BUILD_DIR" >> "$GITHUB_OUTPUT"

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.prepare.outputs.build_dir }}

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v1
